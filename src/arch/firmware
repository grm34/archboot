#!/bin/bash

#                        FIRMWARE DETECTION
# ============================================================================
# Here we detect if system is running on UEFI or BIOS firmware to properly
# set partition table, code, type, boot filesystem and to store them.
# Then we detect processor to properly define CPU microcode updates.
# ============================================================================

_firmware() {

    _info "Firmware detection"

    # UEFI Firmware
    if [ -d /sys/firmware/efi/efivars ]; then
        export FIRMWARE="UEFI"
        export PART_TABLE="GPT"
        export PART_CODE="g"
        export PART_TYPE=""
        export MOUNT_TYPE="-t vfat "
        export BOOT_FILESYSTEM="fat -F32"
        _note "UEFI firmware detected!"

    # BIOS Firmware
    else
        export FIRMWARE="BIOS"
        export PART_TABLE="MBR"
        export PART_CODE="o"
        export PART_TYPE="p\n"
        export MOUNT_TYPE=""
        export BOOT_FILESYSTEM="ext4"
        _note "BIOS firmware detected!"
    fi
}

_cpu() {
    _info "Processor detection"
    CPU_LIST=(Intel AMD)
    for CPU in "${CPU_LIST[@]}"; do
        CHECK_CPU=$(lscpu | grep "${CPU}")
        if [[ ${CHECK_CPU} ]]; then
            _note "${CPU} processor detected!"
            export MICROCODE="${CPU^^}_CPU"
            export UCODE=${CPU,,}
        fi
    done
    if [[ ! ${MICROCODE} ]]; then
        _note "unreconized CPU! Microcode updates will no be installed."
    fi
}

# archboot by grm34 under Apache License 2.0
# ============================================================================
